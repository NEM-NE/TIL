# 5주차 정리

# Deployment

## 역할 이해하기

디플로이먼트의 주된 역할

- 파드의 개수를 관리하는 것(개수 고정, 스케일링)
- 롤아웃, 롤백 기능 지원

기존 수평 분산 시스템 → 로드밸런서 & 여러대의 서버로 구성, 상황에 따라 여러대의 서버가 부하를 막아주거나 장애를 막아줌

쿠버네티스 클러스터 → 파드가 서버의 역할을 담당, 동일한 상황에서 파드가 같은 역할을 수행

즉, 파드를 관리하는 것이 시스템의 처리 능력, 가용성, 비용측면에서 매우 중요

⇒ 결과적으로 백엔드 워크플로우에 적합

디플로이먼트는 실제로 디플로이먼트 컨트롤러, 레플리카셋, 파드들을 가지고 있다.

![Untitled](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/Untitled.png)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-deploy
spec:
  replicas: 3
  selector:
		# 디플로이먼트 제어하의 레플리카셋과 파드를 대응시키기 위해 사용
    matchLabels: # 컨트롤러와 파드를 대응시키는 라벨
      app: web # <- 파드에 반드시 해당 라벨이 존재해야됨
  template: # 파드 템플릿 - 파드 YAML과 동일하다
    metadata:
      labels:
        app: web # 동일한 라벨이 있다
    spec:
      containers:
      - name: nginx
        image: nginx:1.16
```

![스크린샷 2022-05-15 오후 4.30.23.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-15_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.30.23.png)

→ 미니쿠베에서는 하나의 노드안에서 생성하지만 멀티 노드 환경에서는 다른 노드에서도 생성될 수 도 있다

![IMG_2096.jpeg](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/IMG_2096.jpeg)

## 스케일 기능

→ 레플리카의 값을 변경하여 파드의 개수를 조절하여 처리능력을 높이거나 낮추는 기능

레플리카의 값을 변경하는 방법 

1. YAML 파일에서 replicas 값을 변경한다.
2. `kubectl scale —replicas=10 deployment.**/이름` 을 입력한다.

만약 클러스터의 자원(CPU, 메모리)가 부족해지면 노드를 추가하여 자원이 생길 때까지 파드 생성이 보류된다.

→ 가상 메모리까지 사용하면서 파드를 생성하지 않음

→ 클러스터의 가용자원을 검토하여 노드 증성을 결정할 필요가 있다.

### 롤아웃 기능

→ 컨테이너의 업데이트, 단 사용자로부터 요청을 계속 받을 수 있도록 정해진 개수만큼 업데이트를 진행할 수 있다.

- 실제로는 롤아웃 기능만으로 충분하지 않으며, 애플리케이션의 설계, 테이블의 설계 캐시 이용 등을 함께 고려해야한다. → 컨테이너는 영속적이지 않기 때문에 반드시 외부에 세션 정보에 보관

![스크린샷 2022-05-15 오후 4.43.18.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-15_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.43.18.png)

kubectl describe deployment를 통해 확인하면 RollingUpdateStrategy에서 최대 25% 정지할 수 있고 최대 25% 더 가동 할수 있음을 의미한다. 이를 기반으로 롤아웃 진행

컨테이너 이미지만 다른 YAML 파일을 apply하면 수행됨.

![스크린샷 2022-05-15 오후 4.53.14.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-15_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_4.53.14.png)

→ replicaset은 그대로 유지한다.

### 롤백 기능

→ 롤아웃과 마찬가지로 점진적으로 예전 컨테이너로 되돌림

`kubectl rollout undo deployment web-deploy`로 롤아웃을 취소 할 수 있음

→ 이전 replicaset을 그대로 활용한다.

### 파드의 IP주소가 변경되는 경우와 아닌 경우

변경되는 경우 → **파드 종료시 IP가 회수되어 다른 파드에 재할당 된다.** 즉, 롤 아웃, 롤백, 스케일은 파드의 IP 주소를 변경시키는 원인이 된다.

변경되지 않는 경우 → 파드 내에 컨테이너를 재시작한 경우

### 자동 복구

여러개의 파드가 동작 중인 노드를 중지하고 다시 가동할 경우

1. 해당 파드들은 Unknown 상태가 되어버림
2. 다시 가동을 하면 노드가 Unknown 상태의 파드들을 삭제해버림
3. 자동 복구까지 5분 정도 걸린다.(그 전까지는 정상 동작)

![스크린샷, 2022-05-16 오전 12.45.26.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.45.26.png)

### 디플로이먼트를 이용한 고가용성 구성

![스크린샷, 2022-05-16 오전 12.48.35.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_12.48.35.png)

→ 하나의 파드와 퍼시스턴트 볼륨을 사용하면 액티브 스탠바이 고가용성 구성(HA)을 만들 수 있음

특정 노드에 문제가 발생하더라도 퍼시스턴트 볼륨에 의해 노드에 종속되지 않고 안전하게 데이터를 보관할 수 있다.

```yaml
# 퍼시스턴트 볼륨
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gvol-1
spec:
  storageClassName: gluster-heketi
  #storageClassName: ibmc-file-bronze   # 용량 20Gi IKS
  accessModes:
   - ReadWriteMany
  resources:
    requests:
      storage: 12Gi
      #storage: 20Gi   # for IKS
---
# MySQL서버 디플로이먼트
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  labels:
    app: mysql
spec:
  selector:
    matchLabels:
      app: mysql
  replicas: 1
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:5.7
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: qwerty
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: pvc
        livenessProbe:
          exec:
            command: ["mysqladmin","-p$MYSQL_ROOT_PASSWORD","ping"]
          initialDelaySeconds: 60
          timeoutSeconds: 10
      volumes:
      - name: pvc
        persistentVolumeClaim:
          claimName: gvol-1
---
# MySQL서버 서비스
apiVersion: v1
kind: Service
metadata:
  name: mysql-dpl
  labels:
    app: mysql
spec:
  type: NodePort
  ports:
  - port: 3306
    nodePort: 30306
  selector:
    app: mysql
```

`kubectl cordon node1`을 통해 특정 노드의 스케줄을 중지할 수 있다.

kubectl drain node1을 해도 cordon이 실행된다.

![스크린샷, 2022-05-16 오전 1.00.09.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.00.09.png)

node1에 있던 파드들은 모두 node2로 이동한다.

![스크린샷, 2022-05-16 오전 1.01.13.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.01.13.png)

`kubectl uncordon node1`로 스케줄 금지 해체할 수 있다.

→ K8s 디플로이먼트를 통해 특정 노드에 있는 파드들을 다른 노드로 옮길 수 있다.

그러나 위 과정에서 파드가 변하기 때문에 파드에 할당된 IP 주소 역시 변하게 된다.

![스크린샷, 2022-05-16 오전 1.03.39.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.03.39.png)

![스크린샷, 2022-05-16 오전 1.04.10.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.04.10.png)

### 마무리

![스크린샷, 2022-05-16 오전 1.13.22.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.13.22.png)

![스크린샷, 2022-05-16 오전 1.13.50.png](5%E1%84%8C%E1%85%AE%E1%84%8E%E1%85%A1%20%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%85%E1%85%B5%203951a5bff3184b1e8b931a83fcb33980/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2022-05-16_%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB_1.13.50.png)